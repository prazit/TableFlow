<!DOCTYPE html>
<!--suppress ELSpecValidationInJSP -->
<html style="background-color: var(--surface-a)">
<f:view xmlns="http://www.w3.org/1999/xhtml"
        xmlns:f="http://java.sun.com/jsf/core"
        xmlns:h="http://java.sun.com/jsf/html"
        xmlns:p="http://primefaces.org/ui"
>

    <h:head>
        <title>TFlow Editor</title>

        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>

    </h:head>
    <h:body style="background-color: var(--surface-a)" styleClass="selectable step#{projectCtl.active(projectCtl.project)}">
        <script>console.log('-- first-line of flow-chart --');</script>

        <input name="selectableId" type="hidden" value="#{projectCtl.project.selectableId}"/>
        <p:remoteCommand name="update#{projectCtl.project.selectableId}" oncomplete="updateComplete('#{projectCtl.project.selectableId}')" update="editorForm:projectName"/>

        <h:outputStylesheet library="css" name="tflow.css#{app.forceReloadResources}" target="head"/>
        <h:outputStylesheet library="css" name="editor.css#{app.forceReloadResources}" target="head"/>
        <h:outputScript library="js" name="editor-page.js#{app.forceReloadResources}" target="head"/>
        <h:outputScript library="js" name="project.js#{app.forceReloadResources}" target="head"/>

        <div class="flow-chart">
            <h:form id="editorForm">
                <p:remoteCommand name="drawLines" action="#{flowchartCtl.drawLines}"/>

                <p:outputPanel id="projectName" style="padding: var(--padding);margin: var(--margin);">
                    <h1 style="color: var(--surface-c);">Project: #{projectCtl.project.name}</h1>
                </p:outputPanel>

                <p:tabView id="tabview" style="padding: var(--padding);margin: var(--margin);">
                    <p:importEnum type="com.tflow.controller.ProjectSection" var="ProjectSection"/>
                    <p:ajax event="tabChange" listener="#{projectCtl.openSection}" update="@parent"/>

                    <p:tab title="#{ProjectSection.DATA_SOURCE.getTitle()}">

                        <p:divider align="left">
                            <div class="inline-flex align-items-center">
                                <i class="pi pi-user mr-2"/>
                                <b>Database Connection</b>
                            </div>
                        </p:divider>

                        <p:outputPanel id="databasetab" styleClass="horizon-scroll-panel">
                            <p:outputPanel styleClass="database-panel">
                                <p:remoteCommand name="refreshDatabaseList" update="editorForm:tabview:databasetab" oncomplete="updatePanelComplete('.database-panel')"/>
                                <p:repeat value="#{projectCtl.databaseList}" var="database">
                                    <p:outputPanel styleClass="data-source flex selectable#{projectCtl.active(database)}">
                                        <input name="selectableId" type="hidden" value="#{database.selectableId}"/>
                                        <p:remoteCommand name="update#{database.selectableId}" update="@parent" oncomplete="updateComplete('#{database.selectableId}')"/>
                                        <b>#{database.name}</b><br/>
                                        <p:graphicImage library="images" name="#{database.dbms.image}"/><br/>
                                        <span>#{database.dbms}</span>
                                    </p:outputPanel>
                                    <p:spacer/>
                                </p:repeat>
                                <p:outputPanel styleClass="data-source flex button" value="addDatabase">
                                    <input name="command" type="hidden" value="addDatabase"/>
                                    <p:remoteCommand name="addDatabase" update="editorForm:tabview:databasetab" onstart="parent.addDatabase()" oncomplete="updatePanelComplete('.database-panel')"/>
                                    <span class="ui-icon pi pi-plus" style="font-size: 2em;"/>
                                    <span>Add Database</span>
                                </p:outputPanel>
                            </p:outputPanel>
                        </p:outputPanel>

                        <p:divider align="left">
                            <div class="inline-flex align-items-center">
                                <i class="pi pi-user mr-2"/>
                                <b>Local Root Directory</b>
                            </div>
                        </p:divider>

                        <p:outputPanel id="localtab" styleClass="horizon-scroll-panel">
                            <p:outputPanel styleClass="local-panel">
                                <p:remoteCommand name="refreshLocalList" update="@parent" oncomplete="updatePanelComplete('.local-panel')"/>
                                <p:repeat value="#{projectCtl.localList}" var="local">
                                    <p:outputPanel styleClass="data-source flex selectable#{projectCtl.active(local)}">
                                        <input name="selectableId" type="hidden" value="#{local.selectableId}"/>
                                        <b>#{local.name}</b><br/>
                                        <p:remoteCommand name="update#{local.selectableId}" update="@parent" oncomplete="updateComplete('#{local.selectableId}')"/>
                                        <p:graphicImage library="images" name="#{local.image}"/><br/>
                                        <span>#{local.rootPath}</span>
                                    </p:outputPanel>
                                    <p:spacer/>
                                </p:repeat>
                                <p:outputPanel styleClass="data-source flex button" value="addLocal">
                                    <input name="command" type="hidden" value="addLocal"/>
                                    <p:remoteCommand name="addLocal" update="editorForm:tabview:localtab" onstart="parent.addLocal()" oncomplete="updatePanelComplete('.local-panel')"/>
                                    <span class="ui-icon pi pi-plus" style="font-size: 2em;"/>
                                    <span>Add Local Path</span>
                                </p:outputPanel>
                            </p:outputPanel>
                        </p:outputPanel>

                        <p:divider align="left">
                            <div class="inline-flex align-items-center">
                                <i class="pi pi-user mr-2"/>
                                <b>Remote Root Directory</b>
                            </div>
                        </p:divider>

                        <p:outputPanel id="sftptab" styleClass="horizon-scroll-panel">
                            <p:outputPanel styleClass="sftp-panel">
                                <p:remoteCommand name="refreshSFTPList" update="@parent" oncomplete="updatePanelComplete('.sftp-panel')"/>
                                <p:repeat value="#{projectCtl.sftpList}" var="sftp">
                                    <p:outputPanel styleClass="data-source flex selectable#{projectCtl.active(sftp)}">
                                        <input name="selectableId" type="hidden" value="#{sftp.selectableId}"/>
                                        <b>#{sftp.name}</b><br/>
                                        <p:remoteCommand name="update#{sftp.selectableId}" update="@parent" oncomplete="updateComplete('#{sftp.selectableId}')"/>
                                        <p:graphicImage library="images" name="#{sftp.image}"/><br/>
                                        <span>#{sftp.rootPath}</span>
                                    </p:outputPanel>
                                    <p:spacer/>
                                </p:repeat>
                                <p:outputPanel styleClass="data-source flex button" value="addSFTP">
                                    <input name="command" type="hidden" value="addSFTP"/>
                                    <p:remoteCommand name="addSFTP" update="editorForm:tabview:sftptab" onstart="parent.addSFTP()" oncomplete="updatePanelComplete('.sftp-panel')"/>
                                    <span class="ui-icon pi pi-plus" style="font-size: 2em;"/>
                                    <span>Add SFTP Path</span>
                                </p:outputPanel>
                            </p:outputPanel>
                        </p:outputPanel>

                        <script>window.parent.contentReady(function () {
                            updatePanelComplete('.database-panel');
                            updatePanelComplete('.sftp-panel');
                            updatePanelComplete('.local-panel');
                        }, "updateDataSourcePanels");
                        </script>

                    </p:tab>

                    <p:tab title="#{ProjectSection.VARIABLE.getTitle()}" styleClass="variable tab">
                        <h2 style="color: var(--surface-c);">Variable Section</h2>
                    </p:tab>

                    <p:tab title="#{ProjectSection.UPLOADED.getTitle()}" styleClass="uploaded tab">
                        <p:divider align="left">
                            <div class="inline-flex align-items-center">
                                <i class="pi pi-upload"/>
                                <b>Uploaded Files (Read Only)</b>
                            </div>
                        </p:divider>
                        <p:outputPanel id="uploadedTab" styleClass="ui-g">
                            <p:outputPanel styleClass="fit-width" style="display:flex;align-content:center;justify-content:center;" rendered="#{projectCtl.uploadedList == null}">
                                <span style="font-size:var(--font-size-1);color:var(--surface-c);">
                                    <i class="pi pi-spinner pi-spin"/>
                                    <span>Loading ...</span>
                                </span>
                            </p:outputPanel>
                            <p:dataList value="#{projectCtl.uploadedList}" var="uploaded" type="none" styleClass="fit-width" rendered="#{projectCtl.uploadedList.size()>0}">
                                <f:facet name="header">
                                    <div class="ui-g">
                                        <div class="ui-g-1" style="text-align: center">No.</div>
                                        <div class="ui-g-3" style="text-align: left">Step</div>
                                        <div class="ui-g-3" style="text-align: center">Type</div>
                                        <div class="ui-g-5" style="text-align: left">Name</div>
                                    </div>
                                </f:facet>
                                <p:outputPanel styleClass="ui-g">
                                    <div class="ui-g-1" style="text-align: center">#{uploaded.index}</div>
                                    <div class="ui-g-3" style="text-align: left">#{uploaded.stepName}</div>
                                    <div class="ui-g-3" style="text-align: center">#{uploaded.dataFileType.getName()}</div>
                                    <p:outputPanel styleClass="ui-g-5" style="text-align: left" rendered="#{not uploaded.fileName.isEmpty()}">#{uploaded.fileName}</p:outputPanel>
                                    <p:outputPanel styleClass="ui-g-5 error-panel" style="text-align: center" rendered="#{uploaded.fileName.isEmpty()}">REQUIRED</p:outputPanel>
                                </p:outputPanel>
                            </p:dataList>
                        </p:outputPanel>
                    </p:tab>

                    <p:tab title="#{ProjectSection.VERSIONED.getTitle()}" styleClass="versioned tab">
                        <p:divider align="left">
                            <div class="inline-flex align-items-center">
                                <i class="pi pi-upload"/>
                                <b>Library Files</b>
                            </div>
                        </p:divider>
                        <p:outputPanel id="versionedTab" styleClass="ui-g versioned-panel">
                            <p:dataList value="#{projectCtl.versionedList}" var="versioned" type="none" styleClass="fit-width">
                                <f:facet name="header">
                                    <div class="ui-g">
                                        <div class="ui-g-1" style="text-align: center">No.</div>
                                        <div class="ui-g-5" style="text-align: left">Id</div>
                                        <div class="ui-g-6" style="text-align: left">Name</div>
                                    </div>
                                </f:facet>
                                <p:outputPanel styleClass="ui-g versioned selectable#{projectCtl.active(versioned)}">
                                    <input name="selectableId" type="hidden" value="#{versioned.selectableId}"/>
                                    <p:remoteCommand name="update#{versioned.selectableId}" update="@parent" oncomplete="updateComplete('#{versioned.selectableId}')"/>
                                    <div class="ui-g-1" style="text-align: center">#{versioned.index}</div>
                                    <div class="ui-g-5" style="text-align: left">#{versioned.id.name()}</div>
                                    <p:outputPanel styleClass="ui-g-6" style="text-align: left" rendered="#{not versioned.name.isEmpty()}">#{versioned.name}</p:outputPanel>
                                    <p:outputPanel styleClass="ui-g-6 error-panel" style="text-align: center" rendered="#{versioned.name.isEmpty()}">REQUIRED</p:outputPanel>
                                </p:outputPanel>
                            </p:dataList>
                        </p:outputPanel>
                        <p:outputPanel rendered="#{projectCtl.versionedList.size() > 0}">
                            <script>$(new function () {
                                updatePanelComplete('.versioned-panel');
                            });
                            </script>
                        </p:outputPanel>
                    </p:tab>

                    <p:tab title="#{ProjectSection.PACKAGE.getTitle()}" styleClass="package tab">
                        <p:outputPanel id="packageTab" styleClass="package-panel">
                            <p:remoteCommand name="updatePackageTab" actionListener="#{projectCtl.refreshBuildingPackage}" update="@parent" oncomplete="console.log('updatePackageTab complated.')"/>
                            <p:remoteCommand name="buildPackage" actionListener="#{projectCtl.buildPackage}" update="@parent" oncomplete="console.log('buildPackage complated.')"/>
                            <p:remoteCommand name="updatePackageList" update="selectPackage" onstart="console.log('updatePackageList start.')"/>

                            <p:outputPanel id="selectPackage" rendered="#{projectCtl.packageList.size() > 0}" styleClass="ui-g">
                                <p:selectOneMenu value="#{projectCtl.selectedPackageId}">
                                    <f:selectItem itemLabel="---- select package here ----" itemValue=""/>
                                    <f:selectItems value="#{projectCtl.packageList}" var="package" itemValue="#{package.id}" itemLabel="#{package.name}"/>
                                    <p:ajax event="change" listener="#{projectCtl.selectedPackageChanged}" update="@parent"/>
                                </p:selectOneMenu>

                                <p:outputPanel styleClass="button">
                                    <input name="command" type="hidden" value="buildPackage"/>
                                    <span class="ui-icon pi pi-save"> Build New Package</span>
                                </p:outputPanel>
                            </p:outputPanel>

                            <p:divider rendered="#{projectCtl.packageList.size() > 0}" layout="horizontal"/>

                            <!-- please select message -->
                            <p:outputPanel rendered="#{projectCtl.pleaseSelectPackage and projectCtl.packageList.size() == 0}"><h2 style="color: var(--surface-c);"><i class="pi pi-info-circle"/> Need to build one package, click menu Build &gt; Package.</h2></p:outputPanel>
                            <p:outputPanel rendered="#{projectCtl.pleaseSelectPackage and projectCtl.packageList.size() > 0}"><h2 style="color: var(--surface-c);"><i class="pi pi-info-circle"/> Select Package from the List above.</h2></p:outputPanel>

                            <!-- building message -->
                            <p:outputPanel id="building" rendered="#{projectCtl.activePackage != null and not projectCtl.pleaseSelectPackage and not projectCtl.activePackage.finished}">
                                <h2 style="color: var(--surface-c);"><i class="fa fa-info"/>Building Package at #{projectCtl.activePackage.buildDate} ... #{projectCtl.activePackage.complete}%</h2>
                                <script>$(function () {
                                    console.log('setTimeout');
                                    var timeoutId = setTimeout(function () {
                                        console.log('call updatePackageTab');
                                        updatePackageTab();
                                        clearTimeout(timeoutId);
                                    }, 3000);
                                });
                                </script>
                            </p:outputPanel>

                            <!-- active package -->
                            <p:outputPanel id="activePackage" rendered="#{not projectCtl.pleaseSelectPackage and projectCtl.activePackage.finished}">
                                <p:outputPanel styleClass="selectable">
                                    <input name="selectableId" type="hidden" value="#{projectCtl.activePackage.selectableId}"/>
                                    <p:remoteCommand name="update#{projectCtl.activePackage.selectableId}" update="@parent" oncomplete="updateComplete('#{projectCtl.activePackage.selectableId}')"/>

                                    <p:fieldset styleClass="ui-g">
                                        <p:outputLabel value="Name : " styleClass="ui-sm-3"/>
                                        <p:outputLabel value="#{projectCtl.activePackage.name}" styleClass="ui-sm-9"/>
                                    </p:fieldset>
                                    <p:fieldset styleClass="ui-g">
                                        <p:outputLabel value="Build : " styleClass="ui-sm-3"/>
                                        <p:datePicker value="#{projectCtl.activePackage.buildDate}" readonly="true"/>
                                    </p:fieldset>
                                    <p:fieldset styleClass="ui-g">
                                        <p:outputLabel value="Built : " styleClass="ui-sm-3"/>
                                        <p:datePicker value="#{projectCtl.activePackage.builtDate}" readonly="true"/>
                                    </p:fieldset>
                                </p:outputPanel>

                                <p:divider layout="horizontal">
                                    <div class="inline-flex align-items-center">
                                        <i class="pi pi-list mr-2"/>
                                        <b>File List</b>
                                    </div>
                                </p:divider>

                                <p:outputPanel styleClass="ui-g">
                                    <p:dataTable value="#{projectCtl.activePackage.fileList}" var="packageFile" styleClass="ui-lg-12">
                                        <p:column styleClass="ui-sm-3" headerText="Path">#{packageFile.buildPath}</p:column>
                                        <p:column styleClass="ui-sm-3" headerText="Name">#{packageFile.name}</p:column>
                                        <p:column styleClass="ui-sm-3" headerText="Type" style="text-align: center">#{packageFile.ext}</p:column>
                                        <p:column styleClass="ui-sm-3" headerText="New" style="text-align: center">
                                            <p:outputPanel rendered="#{packageFile.updated}"><i class="pi pi-check" style="font-size: 2em; color: var(--surface-c);"/></p:outputPanel>
                                            <p:outputPanel rendered="#{not packageFile.updated}"><i class="pi pi-times" style="color: var(--surface-d);"/></p:outputPanel>
                                        </p:column>
                                    </p:dataTable>
                                </p:outputPanel>
                            </p:outputPanel>

                            <script>$(function () {
                                updatePanelComplete('.package-panel');
                            });</script>
                        </p:outputPanel>
                    </p:tab>
                </p:tabView>

            </h:form>
        </div>

        <script>console.log('-- last-line of flow-chart --');</script>
    </h:body>
</f:view>
</html>