<!DOCTYPE html>
<html>
<f:view xmlns="http://www.w3.org/1999/xhtml"
        xmlns:f="http://java.sun.com/jsf/core"
        xmlns:h="http://java.sun.com/jsf/html"
        xmlns:p="http://primefaces.org/ui"
        xmlns:ui="http://java.sun.com/jsf/facelets">

    <h:head>
        <title>TFlow Editor</title>

        <meta charset="utf-8"/>
        <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>

        <h:outputStylesheet library="css" name="editor.css#{editorCtl.forceReloadResources}" target="head"/>
    </h:head>
    <h:body>
        <h:outputScript library="js" name="editor.js#{editorCtl.forceReloadResources}" target="head"/>
        <script>console.log('-- first-line of editor --');</script>
        <div class="container">
            <ui:include src="resources/exceptionMessage.xhtml"/>
            <ui:include src="resources/topMenu.xhtml"/>
            <div class="screen-area">
                <p:splitter styleClass="p-mb-3" gutterSize="5">
                    <p:splitterPanel styleClass="left-panel p-d-flex p-ai-center p-jc-center" minSize="15" size="15">
                        <p:panel header="Step List" styleClass="tool-panel">
                            <f:facet name="actions">
                                <p:commandButton id="leftToggle" type="button"
                                                 styleClass="left-panel-toggle close"
                                                 icon="pi pi-times"/>
                            </f:facet>
                            <h:form id="stepForm">
                                <p:tabView id="leftPanel" activeIndex="#{editorCtl.stepListActiveTab}">
                                    <p:tab title="Step" id="stepList">
                                        <div>
                                            <span class="label">Project: </span>
                                            <span class="value">#{editorCtl.projectName}</span>
                                        </div>
                                        <p:separator/>
                                        <p:menu model="#{editorCtl.stepMenu}"/>
                                    </p:tab>
                                    <p:tab title="History" id="actionList">
                                        <p:scrollPanel style="height: 100%;">
                                            <div>
                                                <p:outputLabel value="Show full action list: "/>
                                                <p:inputSwitch value="#{editorCtl.fullActionList}" onLabel="1" offLabel="0" styleClass="float-right">
                                                    <p:ajax event="change" listener="#{editorCtl.refreshActionList}" update="@parent"/>
                                                </p:inputSwitch>
                                            </div>
                                            <p:repeat value="#{editorCtl.actionList}" var="action">
                                                <p:outputPanel class="column">
                                                    <p:graphicImage library="images" name="#{action.image}"/>
                                                    <div style="display: inline-block">
                                                        <p:outputLabel id="actionName" value="#{action.name}"/>
                                                        <p:tooltip for="actionName" value="#{action.description}"/>
                                                    </div>
                                                    <br/>
                                                    <p:outputLabel value="(#{action.code}:#{action.id})" rendered="#{not editorCtl.fullActionList}"/>
                                                    <p:commandButton value="Undo" action="#{editorCtl.undo(action)}" rendered="#{action.undo and not editorCtl.fullActionList}" styleClass="float-right" update="@parent" onstart="serverStart()" oncomplete="serverEnd()"/>
                                                </p:outputPanel>
                                            </p:repeat>
                                        </p:scrollPanel>
                                    </p:tab>
                                    <p:ajax event="tabChange" listener="#{editorCtl.stepListTabChanged}"/>
                                </p:tabView>
                                <p:remoteCommand name="setActiveObj" action="#{editorCtl.selectObject}" update="propertyForm"/>
                                <p:remoteCommand name="setToolPanel" action="#{editorCtl.setToolPanel}" update="stepForm,propertyForm"/>
                            </h:form>
                        </p:panel>
                    </p:splitterPanel>

                    <p:splitterPanel styleClass="main-panel p-d-flex p-ai-center p-jc-center" minSize="15" size="55">
                        <p:panel header="" styleClass="tool-panel">
                            <f:facet name="actions">
                                <h:form id="actionForm">
                                    <p:remoteCommand name="submitZoom" action="#{editorCtl.submitZoom}"/>

                                    <p:menubar>
                                        <p:submenu label="Add">
                                            <p:menuitem value="Step" icon="pi pi-fw pi-plus" actionListener="#{editorCtl.addStep}" update="stepForm,propertyForm"/>
                                            <p:divider/>
                                            <p:menuitem value="Root Directory" icon="pi pi-fw pi-plus" actionListener="#{editorCtl.addLocal}" update="stepForm,propertyForm"/>
                                            <p:menuitem value="FTP Connection" icon="pi pi-fw pi-plus" actionListener="#{editorCtl.addSFTPConnection}" update="stepForm,propertyForm"/>
                                            <p:menuitem value="DataBase Connection" icon="pi pi-fw pi-plus" actionListener="#{editorCtl.addDBConnection}" update="stepForm,propertyForm"/>
                                            <p:divider/>
                                            <p:menuitem value="Data File" icon="pi pi-fw pi-plus" actionListener="#{editorCtl.addDataFile}" update="stepForm,propertyForm"/>
                                        </p:submenu>

                                        <p:divider layout="vertical"/>

                                        <p:submenu label="View">
                                            <p:menuitem value="Step List" icon="pi pi-fw pi-list" onclick="toggleLeft()"/>
                                            <p:menuitem value="Property List" icon="pi pi-fw pi-list" onclick="toggleRight()"/>
                                            <p:divider/>
                                            <p:menuitem value="Table Buttons" icon="pi pi-fw pi-list" onclick="toggleActionButtons()"/>
                                        </p:submenu>

                                        <p:submenu label="Testing">
                                            <p:submenu label="Kafka">
                                                <p:menuitem value="Send Message | Get Data" icon="pi pi-fw pi-plus" actionListener="#{editorCtl.testGetData}"/>
                                                <p:menuitem value="Send Message | Get Project" icon="pi pi-fw pi-plus" actionListener="#{editorCtl.testOpenProject}"/>
                                                <p:menuitem value="Send Message | Save Project as Template" icon="pi pi-fw pi-plus" actionListener="#{editorCtl.testSaveProjectTemplate}"/>
                                            </p:submenu>
                                            <p:submenu label="Java Serialize">
                                                <p:menuitem value="Write (Action List)" icon="pi pi-fw pi-plus" actionListener="#{editorCtl.testWriteActionList}"/>
                                                <p:menuitem value="Write (Action List with header)" icon="pi pi-fw pi-plus" actionListener="#{editorCtl.testWriteHeader}"/>
                                                <p:menuitem value="Write (Action List with footer)" icon="pi pi-fw pi-plus" actionListener="#{editorCtl.testWriteFooter}"/>
                                                <p:menuitem value="Write (Kafka Record Value)" icon="pi pi-fw pi-plus" actionListener="#{editorCtl.testWriteKafkaRecordValue}"/>
                                                <p:divider/>
                                                <p:menuitem value="Read (Action List)" icon="pi pi-fw pi-plus" actionListener="#{editorCtl.testReadActionList}"/>
                                                <p:menuitem value="Read (Kafka Record Value)" icon="pi pi-fw pi-plus" actionListener="#{editorCtl.testReadKafkaRecordValue}"/>
                                                <p:menuitem value="Scan (Unknown Object)" icon="pi pi-fw pi-plus" actionListener="#{editorCtl.testScanSerialize}"/>
                                            </p:submenu>
                                            <p:submenu label="Json Serialize">
                                                <p:menuitem value="toJSON" icon="pi pi-fw pi-plus" actionListener="#{editorCtl.testToJson}"/>
                                                <p:menuitem value="fromJSON" icon="pi pi-fw pi-plus" actionListener="#{editorCtl.testFromJson}"/>
                                            </p:submenu>
                                        </p:submenu>

                                        <p:divider layout="vertical"/>

                                        <p:menuitem styleClass="zoom-factor">
                                            <p:outputLabel value="Zoom : "/>
                                            <p:inputNumber id="zoomFactor" symbol="%" symbolPosition="s"
                                                           required="true" value="#{editorCtl.zoom}"
                                                           onkeyup="zoomStart();zoomEnd(1);"/>
                                        </p:menuitem>

                                        <p:menuitem styleClass="zoom-factor">
                                            <p:slider for="zoomFactor" minValue="0.01" maxValue="200"
                                                      step="0.01" range="max" onSlideStart="zoomStart()"
                                                      onSlide="zoom()" onSlideEnd="zoomEnd(1)"/>
                                        </p:menuitem>
                                    </p:menubar>
                                </h:form>
                            </f:facet>

                            <!-- TODO: change flowchart.xhtml to blank.xhtml, then put flowchart.xhtml in the refreshFlowchart js-function -->
                            <iframe id="flowchart" src="flowchart.xhtml"></iframe>

                        </p:panel>
                    </p:splitterPanel>

                    <p:splitterPanel styleClass="right-panel p-d-flex p-ai-center p-jc-center" minSize="15" size="30">
                        <p:panel header="Property List" styleClass="tool-panel">
                            <f:facet name="actions">
                                <p:commandButton id="rightToggle" type="button" styleClass="right-panel-toggle close" icon="pi pi-times"/>
                            </f:facet>

                            <h:form id="propertyForm">
                                <p:scrollPanel styleClass="properties" style="height:100%;">
                                    <p:importEnum type="com.tflow.model.editor.PropertyType" var="PropertyType"/>
                                    <h3>#{editorCtl.activeObject.properties}</h3>
                                    <sup>#{editorCtl.activeObject.getClass().getTypeName()}</sup>
                                    <p:divider/>
                                    <input name="selectableId" value="#{editorCtl.activeObject.selectableId}" class="hidden-input"/>
                                    <input value="" class="ui-g-8 prev-input"/>

                                    <p:repeat value="#{editorCtl.propertyList}" var="prop">

                                        <p:divider rendered="#{PropertyType.SEPARATOR==prop.type}" align="left">
                                            <span>#{prop.label}</span>
                                        </p:divider>

                                        <p:outputPanel styleClass="ui-g" rendered="#{PropertyType.READONLY==prop.type}">
                                            <div class="ui-g-4 property-label">#{prop.label}</div>
                                            <div class="ui-g-8 property-label">#{prop.hasParent()?editorCtl.activeObject[prop.varParent][prop.var]:editorCtl.activeObject[prop.var]}</div>
                                        </p:outputPanel>

                                        <p:outputPanel styleClass="ui-g" rendered="#{PropertyType.BOOLEAN==prop.type}">
                                            <div class="ui-g-4 property-label">#{prop.label}</div>
                                            <div class="ui-g-8">
                                                <p:inputSwitch value="#{prop.hasParent()?editorCtl.activeObject[prop.varParent][prop.var]:editorCtl.activeObject[prop.var]}">
                                                    <p:ajax event="change" onsuccess="updateEm('#{editorCtl.activeObject.selectableId}');#{prop.javaScript}" process="@this" update="#{prop.update}"/>
                                                </p:inputSwitch>
                                            </div>
                                            <div class="ui-g-12" style="font-size:8px !important;color:gray;">#{prop}</div>
                                        </p:outputPanel>

                                        <p:outputPanel styleClass="ui-g" rendered="#{PropertyType.STRING==prop.type}">
                                            <div class="ui-g-4 property-label">#{prop.label}</div>
                                            <p:inputText value="#{prop.hasParent()?editorCtl.activeObject[prop.varParent][prop.var]:editorCtl.activeObject[prop.var]}" styleClass="ui-g-8">
                                                <p:ajax event="change" listener="#{editorCtl.propertyChanged(prop)}" onsuccess="updateEm('#{editorCtl.activeObject.selectableId}');#{prop.javaScript}" process="@this" update="#{prop.update}"/>
                                            </p:inputText>
                                            <div class="ui-g-12" style="font-size:8px !important;color:gray;">#{prop}</div>
                                        </p:outputPanel>

                                        <p:outputPanel styleClass="ui-g" rendered="#{PropertyType.STRINGARRAY==prop.type}">
                                            <div class="ui-g-4 property-label">#{prop.label}</div>
                                            <p:inputTextarea value="#{prop.hasParent()?editorCtl.activeObject[prop.varParent][prop.var]:editorCtl.activeObject[prop.var]}" converter="StringArray" converterParam="#{prop.params[0]}" styleClass="ui-g-8">
                                                <p:ajax event="change" onsuccess="updateEm('#{editorCtl.activeObject.selectableId}');#{prop.javaScript}" process="@this" update="#{prop.update}"/>
                                            </p:inputTextarea>
                                            <div class="ui-g-12" style="font-size:8px !important;color:gray;">#{prop}</div>
                                        </p:outputPanel>

                                        <p:outputPanel styleClass="ui-g" rendered="#{PropertyType.INT==prop.type}">
                                            <div class="ui-g-4 property-label">#{prop.label}</div>
                                            <p:inputNumber value="#{prop.hasParent()?editorCtl.activeObject[prop.varParent][prop.var]:editorCtl.activeObject[prop.var]}" styleClass="ui-g-8">
                                                <p:ajax event="change" onsuccess="updateEm('#{editorCtl.activeObject.selectableId}');#{prop.javaScript}" process="@this" update="#{prop.update}"/>
                                            </p:inputNumber>
                                            <div class="ui-g-12" style="font-size:8px !important;color:gray;">#{prop}</div>
                                        </p:outputPanel>

                                        <p:outputPanel styleClass="ui-g" rendered="#{PropertyType.COLUMNARRAY==prop.type}">
                                            <div class="ui-g-4 property-label">#{prop.label}</div>
                                            <p:selectCheckboxMenu value="#{prop.hasParent()?editorCtl.activeObject[prop.varParent][prop.var]:editorCtl.activeObject[prop.var]}" styleClass="ui-g-8">
                                                <f:selectItems value="#{editorCtl.getColumnList((prop.paramCount() > 1)?editorCtl.activeObject[prop.params[0]][prop.params[1]]:editorCtl.activeObject[prop.params[0]])}" var="column" itemLabel="#{column.label}" itemValue="#{column.value}"/>
                                                <p:ajax event="change" onsuccess="updateEm('#{editorCtl.activeObject.selectableId}');#{prop.javaScript}" process="@this" update="#{prop.update}"/>
                                            </p:selectCheckboxMenu>
                                            <div class="ui-g-12" style="font-size:8px !important;color:gray;">#{prop}</div>
                                        </p:outputPanel>

                                        <p:outputPanel styleClass="ui-g" rendered="#{prop.type.isItemList()}">
                                            <div class="ui-g-4 property-label">#{prop.label}</div>
                                            <p:selectOneMenu value="#{prop.hasParent()?editorCtl.activeObject[prop.varParent][prop.var]:editorCtl.activeObject[prop.var]}" styleClass="ui-g-8">
                                                <f:selectItem itemLabel="-- select one --"/>
                                                <f:selectItems value="#{editorCtl.getItemList(prop.type,prop.params)}" var="item" itemLabel="#{item.label}" itemValue="#{item.value}"/>
                                                <p:ajax event="change" onsuccess="updateEm('#{editorCtl.activeObject.selectableId}');#{prop.javaScript}" process="@this" update="#{prop.update}"/>
                                            </p:selectOneMenu>
                                            <div class="ui-g-12" style="font-size:8px !important;color:gray;">#{prop}</div>
                                        </p:outputPanel>

                                    </p:repeat>

                                    <input value="" class="ui-g-8 next-input"/>

                                </p:scrollPanel>
                                <script>contentReady(propertyCreated, 'propertyCreated');</script>
                            </h:form>
                        </p:panel>
                    </p:splitterPanel>
                </p:splitter>
            </div>
        </div>
        <script>console.log('-- last-line of editor --');</script>
    </h:body>
</f:view>
</html>
