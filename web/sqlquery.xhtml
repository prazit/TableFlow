<!DOCTYPE html>
<!--suppress ELSpecValidationInJSP -->
<html style="background-color: var(--surface-a)">
<f:view xmlns="http://www.w3.org/1999/xhtml"
        xmlns:f="http://java.sun.com/jsf/core"
        xmlns:h="http://java.sun.com/jsf/html"
        xmlns:p="http://primefaces.org/ui"
        xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
>

    <h:head>
        <title>TFlow Editor</title>

        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>

    </h:head>
    <h:body style="background-color: var(--surface-a)">
        <h:outputStylesheet library="css" name="tflow.css#{app.forceReloadResources}" target="head"/>
        <h:outputStylesheet library="css" name="editor.css#{app.forceReloadResources}" target="head"/>
        <h:outputScript library="js" name="editor-page.js#{app.forceReloadResources}" target="head"/>
        <h:outputScript library="js" name="sqlquery.js#{app.forceReloadResources}" target="head"/>

        <p:remoteCommand name="refreshElement" action="#{sqlQueryCtl.updateComponent}" oncomplete="tflow.postRefreshElement();"/>
        <p:remoteCommand name="clientReady" action="#{sqlQueryCtl.clientReady}" update="queryForm:tabview"/>
        <p:remoteCommand name="selectQueryColumn" action="#{sqlQueryCtl.columnSelected}" oncomplete="refreshProperties()"/>
        <p:remoteCommand name="sortColumns" action="#{sqlQueryCtl.sortColumns}"/>

        <script>console.log('-- first-line of sql query --');</script>

        <p:importEnum type="com.tflow.controller.SQLQuerySection" var="SQLQuerySection"/>
        <p:importEnum type="com.tflow.model.editor.room.RoomType" var="RoomType"/>

        <div class="flow-chart">
            <h:form id="queryForm">
                <p:tabView id="tabview" style="padding: var(--padding);margin: var(--margin);" class="query-cover">
                    <p:ajax event="tabChange" listener="#{sqlQueryCtl.openSection}" update="#{sqlQueryCtl.openSectionUpdate}"/>

                    <p:tab title="#{SQLQuerySection.QUERY.title}">
                        <f:facet name="title">
                            <i class="pi #{SQLQuerySection.QUERY.icon}"/>
                            <p:outputLabel value=" #{SQLQuerySection.QUERY.title}"/>
                        </f:facet>

                        <p:divider align="left">
                            <div class="inline-flex align-items-center">
                                <i class="pi pi-pointer"/>
                                <b>Select Column</b>
                            </div>
                        </p:divider>

                        <p:outputPanel id="queryTab" class="query">
                            <input name="selectableId" type="hidden" value="#{sqlQueryCtl.query.selectableId}"/>
                            <p:remoteCommand name="update#{sqlQueryCtl.query.selectableId}" oncomplete="updateComplete('#{sqlQueryCtl.query.selectableId}')"/>

                            <div class="query-panel ui-g">

                                <div class="select-table-panel ui-g-2">
                                    <div class="vertical-scroll-panel">
                                        <p:dataList value="#{sqlQueryCtl.tableList}" var="tableName">
                                            <div>#{tableName}</div>
                                        </p:dataList>
                                    </div>
                                </div>

                                <div class="select-column-panel ui-g-10">
                                    <div class="horizon-scroll-panel fit-height">
                                        <table class="query-tower">
                                            <p:repeat value="#{sqlQueryCtl.query.tower.floorList}" var="floor">
                                                <tr>
                                                    <td>
                                                        <p:spacer width="50"/>
                                                    </td>
                                                    <p:repeat value="#{floor.roomList}" var="room">
                                                        <td style="vertical-align:top">
                                                            <p:panel header="" styleClass="query-table qt#{room.id}" rendered="#{room.roomType==RoomType.QUERY_TABLE}">
                                                                <f:facet name="actions">
                                                                    <div class="#{room.endPlug.styleClass}" id="#{room.endPlug}">
                                                                        <input name="removeButtonTip" type="hidden" value="#{room.endPlug.removeButtonTip}"/>
                                                                    </div>
                                                                    <div id="#{room.id}" class="hiddden"></div>
                                                                    <div style="display:inline-block">
                                                                        <b>#{room.name}</b>
                                                                    </div>
                                                                    <p:menuButton icon="pi pi-bars">
                                                                        <p:menuitem value="Select All" icon="pi pi-checked" onclick="selectTableColumns(#{room.id},true)"/>
                                                                        <p:menuitem value="Unselect All" icon="pi pi-unchecked" onclick="selectTableColumns(#{room.id},false)"/>

                                                                        <p:divider layout="horizontal"/>

                                                                        <p:submenu label="Sort by">
                                                                            <p:menuitem value="Name" icon="pi pi-sort" onclick="sortTableColumns(#{room.id},true,false)"/>
                                                                            <p:menuitem value="Name (Max First)" icon="pi pi-sort" onclick="sortTableColumns(#{room.id},true,true)"/>
                                                                            <p:menuitem value="Index" icon="pi pi-sort" onclick="sortTableColumns(#{room.id},false,false)"/>
                                                                            <p:menuitem value="Index (Max First)" icon="pi pi-sort" onclick="sortTableColumns(#{room.id},false,true)"/>
                                                                        </p:submenu>
                                                                    </p:menuButton>
                                                                    <div class="#{room.startPlug.styleClass}" id="#{room.startPlug}"></div>
                                                                </f:facet>

                                                                <p:outputPanel rendered="#{room.columnList.size()==0}" styleClass="column">
                                                                    <label>(no column)</label>
                                                                </p:outputPanel>

                                                                <p:repeat value="#{room.columnList}" var="column">
                                                                    <p:outputPanel styleClass="selectable column#{column.selected?' selected':''}">
                                                                        <div id="#{room.id}.#{column.id}" class="hidden"></div>
                                                                        <label class="number">#{column.index}</label>
                                                                        <label>#{column.name}</label>
                                                                    </p:outputPanel>
                                                                </p:repeat>
                                                            </p:panel>
                                                        </td>
                                                        <td>
                                                            <p:spacer width="50"/>
                                                        </td>
                                                    </p:repeat>
                                                </tr>
                                            </p:repeat>
                                        </table>
                                    </div>
                                </div>

                            </div>

                            <p:outputPanel class="query-actions" rendered="#{sqlQueryCtl.query.id > 0}">
                                <p:commandButton icon="pi pi-chevron-right" iconPos="right" value="Close Query" onclick="window.parent.closeQuery([{name: 'querySelectableId', value: '#{sqlQueryCtl.query.selectableId}'}]);"/>
                                <script>$(function () {
                                    $('.query-actions').appendTo($('.query-cover'));
                                });
                                </script>
                            </p:outputPanel>

                            <script>$(function () {
                                selectableHandle($('.selectable'));
                            });
                            </script>
                        </p:outputPanel>
                    </p:tab>

                    <p:tab title="#{SQLQuerySection.FILTER.title}">
                        <f:facet name="title">
                            <i class="pi #{SQLQuerySection.FILTER.icon}"/>
                            <p:outputLabel value=" #{SQLQuerySection.FILTER.title}"/>
                        </f:facet>

                        <p:divider align="left">
                            <div class="inline-flex align-items-center">
                                <i class="pi pi-database"/>
                                <b>Where conditions</b>
                            </div>
                        </p:divider>

                        <p:outputPanel id="filterTab" class="filter">
                            <input name="selectableId" type="hidden" value="#{sqlQueryCtl.selectableFilter.selectableId}"/>
                            <p:remoteCommand name="update#{sqlQueryCtl.selectableFilter.selectableId}" oncomplete="updateComplete('#{sqlQueryCtl.selectableFilter.selectableId}')"/>

                            <p:dataTable value="#{sqlQueryCtl.query.filterList}" var="filter">
                                <p:column>#{filter}</p:column>
                            </p:dataTable>
                        </p:outputPanel>
                    </p:tab>

                    <p:tab title="#{SQLQuerySection.SORT.title}">
                        <f:facet name="title">
                            <i class="pi #{SQLQuerySection.SORT.icon}"/>
                            <p:outputLabel value=" #{SQLQuerySection.SORT.title}"/>
                        </f:facet>

                        <p:divider align="left">
                            <div class="inline-flex align-items-center">
                                <i class="pi pi-database"/>
                                <b>Order by</b>
                            </div>
                        </p:divider>

                        <p:outputPanel id="sortTab" class="sort">
                            <input name="selectableId" type="hidden" value="#{sqlQueryCtl.selectableSort.selectableId}"/>
                            <p:remoteCommand name="update#{sqlQueryCtl.selectableSort.selectableId}" oncomplete="updateComplete('#{sqlQueryCtl.selectableSort.selectableId}')"/>

                            <p:dataTable value="#{sqlQueryCtl.query.sortList}" var="sort">
                                <p:column>#{sort}</p:column>
                            </p:dataTable>
                        </p:outputPanel>
                    </p:tab>

                    <p:tab title="#{SQLQuerySection.SQL.title}">
                        <f:facet name="title">
                            <i class="pi #{SQLQuerySection.SQL.icon}"/>
                            <p:outputLabel value=" #{SQLQuerySection.SQL.title}"/>
                        </f:facet>

                        <p:divider align="left">
                            <div class="inline-flex align-items-center">
                                <i class="pi pi-code"/>
                                <b>Generated</b>
                            </div>
                        </p:divider>

                        <p:outputPanel id="sqlTab" class="preview">
                            <input name="selectableId" type="hidden" value="#{sqlQueryCtl.selectablePreview.selectableId}"/>
                            <p:remoteCommand name="update#{sqlQueryCtl.selectablePreview.selectableId}" oncomplete="updateComplete('#{sqlQueryCtl.selectablePreview.selectableId}')"/>

                            GENERATING SQL ...
                        </p:outputPanel>
                    </p:tab>
                </p:tabView>
            </h:form>
        </div>

        <script>console.log('-- last-line of sql query --');</script>
    </h:body>
</f:view>
</html>